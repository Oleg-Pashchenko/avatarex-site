{% extends "core/base.html" %}

{% block head %}
    {{ block.super }}
{% endblock %}
{% block content %}
    <h3>Настройки приложения:</h3>
    <legend class="border-bottom mb-4"></legend>

    <div class="mt-3">
        <div class="input-group-prepend">
            <span class="input-group-text">OpenAI API KEY:</span>
            <input type="text" id="gpt-token" value="{{ gpt_token }}">
            <button class="input-group-text input-group-button" onclick="updateToken();">Обновить</button>
        </div>
    </div>
    <div class="mt-3">
        <div class="input-group-prepend">
            <a class="input-group-text" href="/api/v1/home/syncronize-amo">Синхронизировать воронки с AmoCRM</a>
            <select id="mySelect" class="input-group-select">
                <option value="{{ selected_mode }}">{{ selected_mode }}</option>
                <option value="{{ disabled_mode }}">{{ disabled_mode }}</option>
            </select>
            <button class="input-group-text input-group-button" onclick="changeMode();">Обновить</button>
        </div>
    </div>

    <h4 class="mt-3">Выберите воронку:</h4>
    <div class="row mt-4 ml-1">
        <div class="pipeline-bar">
            {% for pipeline in pipelines %}
                <a class="pipeline-item col" href="#"
                   data-pipeline="{{ pipeline.id }}"> {{ pipeline.name }}</a>

            {% endfor %}
        </div>
    </div>
    <h4 class="mt-5">На каких стадиях принимать сообщения:</h4>
    <div class="row mt-4 ml-1">
        <div class="statuses-bar">
        </div>
    </div>

    <div class="col-12 mt-5">
        <div class="mt-3">
            <div class="input-group-prepend">

                <a class="change-work-mode col-6 mr-3" id="default-mode-settings" href="{% url 'default_mode' %}">Настроить
                    стандартный режим
                    работы</a>
                <a class="change-work-mode col-6" id="database-mode-settings" href="{% url 'db_mode' %}">Настроить режим
                    работы с внешней базой
                    данных</a>
            </div>
        </div>
    </div>



    <script>
        const pipelineLinks = document.querySelectorAll('.pipeline-item');


        function updateToken() {
            tokenEl = document.getElementById('gpt-token');
            fetch(`/api/v1/home/update-token?token=${tokenEl.value}`);
        }

        function changeMode() {
            pipeline = document.querySelector('.selected-pipeline');
            pipelineId = pipeline.getAttribute('data-pipeline');
            fetch(`/api/v1/home/update-mode?pipeline=${pipelineId}`);
        }

        function getStages(link) {
            const pipelineId = link.getAttribute('data-pipeline');
            const data = {pipeline: pipelineId};
            var link1 = document.getElementById('default-mode-settings');
            var link2 = document.getElementById('database-mode-settings');
            link1.setAttribute("href", `/default-mode?pipeline=${pipelineId}`);
            link2.setAttribute("href", `/database-mode?pipeline=${pipelineId}`);

            const requestOptions = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            };
            fetch(`/api/v1/home/get_stages_by_pipeline/`, requestOptions)
                .then(function (response) {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('Ошибка в ответе сервера: ' + response.status);
                    }
                })
                .then(function (jsonResponse) {
                    pipelineLinks.forEach(pipelineLink => {
                        pipelineLink.classList.remove('selected-pipeline');
                    });
                    link.classList.add('selected-pipeline');
                    var statusesBar = document.querySelector(".statuses-bar");
                    statusesBar.innerHTML = "";
                    var statusesList = document.createElement("ul");
                    statusesList.classList.add("list-inline", "row"); // Добавляем класс Bootstrap для горизонтального списка


                    var selectElement = document.getElementById('mySelect');

                    var newOption1 = new Option(jsonResponse.selected_mode, 'selected_mode');
                    var newOption2 = new Option(jsonResponse.disabled_mode, 'disabled_mode');

                    while (selectElement.options.length > 0) {
                        selectElement.options.remove(0);
                    }
                    selectElement.add(newOption1);
                    selectElement.add(newOption2);


                    jsonResponse.stages.forEach(function (status) {

                        var link = document.createElement("a");
                        if (status.is_active) {
                            link.classList.add("a", "selected-stage"); // Добавляем класс "btn-primary" для активных статусов
                            link.style.color = "white";
                        }
                        link.classList.add("a", "stage");
                        link.classList.add("a", "input-group-text");


                        link.href = `/api/v1/home/set_stage_by_pipeline?status=${status.status_id}&pipeline=${pipelineId}`;
                        link.setAttribute("data-pipeline", status.id);
                        link.textContent = status.name;

                        statusesList.appendChild(link);
                    });
                    statusesBar.appendChild(statusesList);

                })
                .catch(function (error) {
                    console.error('Произошла ошибка:', error);
                });
        }

        getStages(pipelineLinks[0]);
        pipelineLinks.forEach(link => {
            link.addEventListener('click', function () {
                getStages(link);
            });
        });
    </script>
{% endblock content %}
