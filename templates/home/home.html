{% extends "core/base.html" %}

{% block head %}
    {{ block.super }}
{% endblock %}
{% block content %}
    <h3>Настройки приложения:</h3>
    <div class="mt-3">
        <div class="input-group-prepend">
            <span class="input-group-text">OpenAI API KEY:</span>
            <input type="text">
        </div>
    </div>
    <h4 class="mt-3">Выберите воронку:</h4>
    <div class="row mt-4 ml-1">
        <div class="pipeline-bar">
            {% for pipeline in pipelines %}
                <a class="pipeline-item col" href="#"
                   data-pipeline="{{ pipeline.id }}"> {{ pipeline.name }}</a>

            {% endfor %}
        </div>
    </div>
    <h4 class="mt-5">На каких стадиях принимать сообщения:</h4>
    <div class="row mt-4 ml-1">
        <div class="statuses-bar">
        </div>
    </div>
    <h4 class="mt-3">Режим работы:</h4>
    <div class="mt-3">
        <div class="input-group-prepend">

            <a class="change-work-mode col-6 mr-3" href="{% url 'default_mode' %}">Настроить стандартный режим работы</a>
            <a class="change-work-mode col-6" href="{% url 'db_mode' %}">Настроить режим работы с внешней базой данных</a>
        </div>
        <div class="widget-container text-white rounded p-2">
            <p class="d-inline-block m-0">После внесения изменений нажмите на кнопку.</p>
            <button id="save-button" class="btn btn-light ml-2">Сохранить</button>
        </div>
    </div>



    <script>
        const pipelineLinks = document.querySelectorAll('.pipeline-item');

        function getStages(link) {
            const pipelineId = link.getAttribute('data-pipeline');
            const data = {pipeline: pipelineId};
            const requestOptions = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            };
            fetch(`/api/v1/home/get_stages_by_pipeline/`, requestOptions)
                .then(function (response) {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('Ошибка в ответе сервера: ' + response.status);
                    }
                })
                .then(function (jsonResponse) {
                    pipelineLinks.forEach(pipelineLink => {
                        pipelineLink.classList.remove('selected-pipeline');
                    });
                    link.classList.add('selected-pipeline');
                    var statusesBar = document.querySelector(".statuses-bar");
                    statusesBar.innerHTML = "";
                    var statusesList = document.createElement("ul");
                    statusesList.classList.add("list-inline"); // Добавляем класс Bootstrap для горизонтального списка

                    jsonResponse.stages.forEach(function (status) {

                        var listItem = document.createElement("li");
                        listItem.classList.add("list-inline-item"); // Добавляем класс Bootstrap для элемента списка

                        var link = document.createElement("a");
                        link.classList.add("a", "stage", "pipeline");

                        if (status.active) {
                            link.classList.add("selected-stage"); // Добавляем класс "btn-primary" для активных статусов
                            link.style.color = "white";
                        }

                        link.href = `/api/v1/home/set_stage_by_pipeline?status=${status.id}&pipeline=${pipelineId}`;
                        link.setAttribute("data-pipeline", status.id);
                        link.textContent = status.name;

                        listItem.appendChild(link);
                        statusesList.appendChild(listItem);
                    });
                    statusesBar.appendChild(statusesList);

                })
                .catch(function (error) {
                    console.error('Произошла ошибка:', error);
                });
        }

        getStages(pipelineLinks[0]);
        pipelineLinks.forEach(link => {
            link.addEventListener('click', function () {
                getStages(link);
            });
        });
    </script>
{% endblock content %}
