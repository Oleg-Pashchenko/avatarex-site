{% extends "core/base.html" %}

{% block head %}
    {{ block.super }}
{% endblock %}
{% load static %}

{% csrf_token %}

{% block content %}
    <style>


    </style>
    <link rel="stylesheet" type="text/css" href="{% static 'css/payment.css' %}">
    <main class="main flow">
        <h1 style="display: flex; justify-content: center; ">Купить подписку</h1>
        <div class="main__cards cards">
            <div class="cards__inner">
                <div class="cards__card card">
                    <div style="text-align: center"><h1 class="card__heading">Старт</h1>
                        <p>на 30 дней</p></div>
                    <div style="text-align: center">
                        {% if user.new_user %}
                            <p class="card__price" id="price">
                                <span style="text-decoration: line-through; color: #484848;">9.000 ₽</span> 3.000 ₽
                            </p>
                        {% else %}
                            <p class="card__price" id="price">9.000 ₽</p>
                        {% endif %}
                    </div>
                    <ul role="list" style="text-align: left; margin-left: 80px" class="card__bullets flow">
                        <li>Личный кабинет</li>
                        <li>Подключение к amoCRM</li>
                        <li>Настройка сценариев (промптов)</li>
                        <li>Выбор этапов для нейро-ассистентов</li>
                        <li>Выбор воронок для нейро-ассистентов</li>
                        <li>Настройка температуры (креативности)</li>
                        <li>Настройка токенов (размер текстов)</li>
                        <li>Настройка выбора модели chatGPT</li>
                        <li>Аналитика</li>
                    </ul>
                    <button style="height: auto" onclick="sendPeriod(1)" class="btn card__cta cta">Начать</button>
                </div>
                <div class="cards__card card">
                    <div style="text-align: center"><h1 class="card__heading">Профи</h1>
                        <p>на 3 года </p></div>
                    <div style="text-align: center">
                        <p class="card__price">95.000 ₽</p>
                    </div>
                    <ul role="list " style="text-align: left; margin-left: 80px" class="card__bullets flow ">
                        <li>Личный кабинет</li>
                        <li>Подключение к amoCRM</li>
                        <li>Настройка сценариев (промптов)</li>
                        <li>Выбор этапов для нейро-ассистентов</li>
                        <li>Выбор воронок для нейро-ассистентов</li>
                        <li>Настройка температуры (креативности)</li>
                        <li>Настройка токенов (размер текстов)</li>
                        <li>Настройка выбора модели chatGPT</li>
                        <li>Аналитика</li>
                    </ul>
                    <button style="height: auto" onclick="sendPeriod(2)" class="btn card__cta cta ">Стать Профи</button>
                </div>
            </div>

            <div class="overlay cards__inner"></div>
        </div>
    </main>

    <legend class="border-bottom mb-1 mt-4 "></legend>
    <div class="container mt-5">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center">Ваша подписка</h1>
            </div>
        </div>

        <div class="row">
            <div class="col-md-4 d-flex align-items-center justify-content-center">
                <label class="h4 mb-0 pb-0" for="exampleFormControlSelect1">Действующая подписка:</label>
            </div>
            <div class="col-md-1">
                <p style="color: greenyellow;" class="h5 mb-1  mt-1 pb-0 "> {{ sub_type }}</p>
            </div>
            <div class="col-md-3">
                <p class="h4 mb-0 pb-0 ">Действует:</p>
            </div>
            <div class="col-md-2">
                <p style="color: greenyellow" class="h5 mb-1 pb-0 mt-1"> {{ days }}</p>
            </div>
        </div>
    </div>
    <legend class="border-bottom mb-2"></legend>
    <!--<div class="pl-3 pr-3 pb-2 pt-0 ">
        <form>
            <div class="form-group">
                <label class="h4" for="exampleFormControlSelect1">Выберите тип подписки</label>
                <select style="background-color: rgb(38, 47, 60);color: white; border: solid rgb(38, 47, 60);font-size: large"
                        class=" col-15 pr-1 form-control input-group-text " id="exampleFormControlSelect1">
                    <option style="text-align: left" class="input-group-text" value="stnd">Standart - 3499 руб./мес.
                    </option>
                    <option style="text-align: left" class="input-groups-text" value="pro">Professional - 7499
                        руб./мес.
                    </option>
                </select>
            </div>
        </form>
    </div>-->



    <div class="pl-3 pr-3 pb-0 pt-0 mt-1 mb-0 "><h1 style="display: flex; justify-content: center; ">Транзакции</h1>
    </div>
    <div class=" mt-2 " style="display: flex; justify-content: center;">
        <table style="background-color: #2b2b2b;" class="table table-dark table-hover">
            <thead class="bg-primary ">

            <tr>
                <th scope="col">#</th>
                <th scope="col">Подписка</th>
                <th scope="col">Дата</th>
                <th scope="col">Сумма</th>
            </tr>
            </thead>
            <tbody>
            {% for transaction in transaction %}
                <tr>
                    <th scope="row">{{ forloop.counter }}</th>
                    {% if transaction.sub_type == 1 %}
                        <td> Подписка на 30 дней</td>
                    {% else %}
                        <td> Подписка на 3 года</td>
                    {% endif %}
                    <td>{{ transaction.date }}</td>
                    <td>{{ transaction.amount }}₽</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    <script>
        // Функция для отправки POST-запроса
        function sendPeriod(value) {
            // Создаем объект FormData для передачи данных в POST-запросе


            const data = {'period': value};

            const requestOptions = {
                method: 'POST',

                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            };
            fetch(`/payment/`, requestOptions)
                .then(response => response.json())
                .then(data => {
                    // Assuming the URL key is stored in the 'urlKey' property of the response data
                    const urlKey = data.url;

                    // Redirect to the URL using window.location.href
                    window.location.href = urlKey;
                })
                .catch(error => {
                    console.error('Error fetching payment information:', error);
                });

        }
    </script>

    <script>console.clear();

    const cardsContainer = document.querySelector(".cards");
    const cardsContainerInner = document.querySelector(".cards__inner");
    const cards = Array.from(document.querySelectorAll(".card"));
    const overlay = document.querySelector(".overlay");

    const applyOverlayMask = (e) => {
        const overlayEl = e.currentTarget;
        const x = e.pageX - cardsContainer.offsetLeft;
        const y = e.pageY - cardsContainer.offsetTop;

        overlayEl.style = `--opacity: 1; --x: ${x}px; --y:${y}px;`;
    };

    const createOverlayCta = (overlayCard, ctaEl) => {
        const overlayCta = document.createElement("div");
        overlayCta.classList.add("cta");
        overlayCta.textContent = ctaEl.textContent;
        overlayCta.setAttribute("aria-hidden", true);
        overlayCard.append(overlayCta);
    };

    const observer = new ResizeObserver((entries) => {
        entries.forEach((entry) => {
            const cardIndex = cards.indexOf(entry.target);
            let width = entry.borderBoxSize[0].inlineSize;
            let height = entry.borderBoxSize[0].blockSize;

            if (cardIndex >= 0) {
                overlay.children[cardIndex].style.width = `${width}px`;
                overlay.children[cardIndex].style.height = `${height}px`;
            }
        });
    });

    const initOverlayCard = (cardEl) => {
        const overlayCard = document.createElement("div");
        overlayCard.classList.add("card");
        createOverlayCta(overlayCard, cardEl.lastElementChild);
        overlay.append(overlayCard);
        observer.observe(cardEl);
    };

    cards.forEach(initOverlayCard);
    document.body.addEventListener("pointermove", applyOverlayMask);
    </script>
{% endblock content %}